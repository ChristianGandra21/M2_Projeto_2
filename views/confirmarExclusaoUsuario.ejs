<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Exclus√£o - <%= user.name %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö†Ô∏è Confirmar Exclus√£o de Usu√°rio</h1>
            <nav>
                <a href="/users" class="btn btn-secondary">‚¨ÖÔ∏è Voltar para Lista</a>
                <a href="/users/edit/<%= user.id %>" class="btn btn-primary">‚úèÔ∏è Editar Usu√°rio</a>
            </nav>
        </header>

        <main>
            <!-- Informa√ß√µes do Usu√°rio -->
            <div class="card">
                <div class="warning-header">
                    <h2>üö® Aten√ß√£o: Exclus√£o Permanente</h2>
                    <p>Voc√™ est√° prestes a excluir permanentemente o seguinte usu√°rio:</p>
                </div>

                <div class="user-details">
                    <div class="user-avatar-large">
                        <span class="avatar-text-large">
                            <%= user.name.charAt(0).toUpperCase() %>
                        </span>
                    </div>

                    <div class="user-info-detailed">
                        <h3 class="user-name-large">üë§ <%= user.name %></h3>
                        <p class="user-email-large">üìß <%= user.email %></p>
                        <p class="user-id-large">üÜî ID: <%= user.id %></p>
                        <% if (user.created_at) { %>
                        <p class="user-date-large">
                            üìÖ Criado em: <%= new Date(user.created_at).toLocaleDateString('pt-BR') %>
                        </p>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Verifica√ß√£o de Tarefas -->
            <div class="card">
                <h3>üîç Verifica√ß√£o de Depend√™ncias</h3>
                <div id="tasks-check">
                    <% if (taskStats.total > 0) { %>
                        <div class="alert alert-warning">
                            <h4>‚ö†Ô∏è <%= taskStats.total %> Tarefa(s) Encontrada(s)</h4>
                            <div class="task-stats">
                                <span class="stat-item">
                                    <span class="stat-number completed"><%= taskStats.completed %></span>
                                    <span class="stat-label">Conclu√≠das</span>
                                </span>
                                <span class="stat-item">
                                    <span class="stat-number pending"><%= taskStats.pending %></span>
                                    <span class="stat-label">Pendentes</span>
                                </span>
                            </div>
                            <p>Este usu√°rio possui as seguintes tarefas associadas:</p>
                            <ul class="tasks-list">
                                <% userTasks.forEach(task => { %>
                                <li>
                                    <strong><%= task.title %></strong>
                                    <% if (task.completed) { %>
                                        <span class="badge badge-success">‚úÖ Conclu√≠da</span>
                                    <% } else { %>
                                        <span class="badge badge-warning">‚è≥ Pendente</span>
                                    <% } %>
                                    <% if (task.due_date) { %>
                                        <small class="task-date">üìÖ <%= new Date(task.due_date).toLocaleDateString('pt-BR') %></small>
                                    <% } %>
                                </li>
                                <% }) %>
                            </ul>
                        </div>
                    <% } else { %>
                        <div class="alert alert-success">
                            <h4>‚úÖ Nenhuma Tarefa Encontrada</h4>
                            <p>Este usu√°rio n√£o possui tarefas associadas. A exclus√£o pode prosseguir com seguran√ßa.</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- A√ß√µes de Confirma√ß√£o -->
            <div class="card">
                <div class="confirmation-actions">
                    <div class="warning-message">
                        <h3>‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!</h3>
                        <p>Ao confirmar, o usu√°rio ser√° permanentemente removido do sistema.</p>
                    </div>

                    <% if (taskStats.total > 0) { %>
                        <!-- Usu√°rio tem tarefas - mostrar op√ß√µes -->
                        <div class="blocked-message">
                            <div class="alert alert-danger">
                                <h4>‚ùå Exclus√£o Bloqueada</h4>
                                <p>Este usu√°rio n√£o pode ser exclu√≠do porque possui <strong><%= taskStats.total %> tarefa(s)</strong> associada(s).</p>
                                <p><strong>Op√ß√µes dispon√≠veis:</strong></p>
                                <ul>
                                    <li>Remover todas as tarefas do usu√°rio</li>
                                    <li>Reatribuir as tarefas para outro usu√°rio</li>
                                    <li>Solicitar exclus√£o for√ßada (administrador)</li>
                                </ul>
                            </div>
                            
                            <div class="blocked-actions">
                                <a href="/tasks" class="btn btn-primary">üìã Gerenciar Tarefas</a>
                                <a href="/users" class="btn btn-secondary">‚¨ÖÔ∏è Voltar</a>
                                
                                <!-- Bot√£o de exclus√£o for√ßada (apenas para demonstra√ß√£o) -->
                                <div class="force-delete-section">
                                    <h5>üîê Exclus√£o For√ßada (Administrador)</h5>
                                    <p class="warning-text">‚ö†Ô∏è Esta op√ß√£o remove o usu√°rio E todas as suas tarefas!</p>
                                    <form action="/users/delete/<%= user.id %>?force=true" method="POST" id="force-delete-form">
                                        <button type="submit" class="btn btn-danger btn-large" id="force-delete-btn">
                                            üí• For√ßar Exclus√£o (Admin)
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    <% } else { %>
                        <!-- Usu√°rio n√£o tem tarefas - permitir exclus√£o -->
                        <div class="action-buttons">
                            <form action="/users/delete/<%= user.id %>" method="POST" id="delete-form">
                                <button type="submit" class="btn btn-danger btn-large" id="confirm-delete">
                                    üóëÔ∏è Confirmar Exclus√£o
                                </button>
                            </form>
                            
                            <a href="/users" class="btn btn-secondary btn-large">
                                ‚ùå Cancelar
                            </a>
                        </div>
                    <% } %>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Interceptar envio do formul√°rio normal
            const deleteForm = document.getElementById('delete-form');
            if (deleteForm) {
                deleteForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const confirmed = confirm(
                        `üö® CONFIRMA√á√ÉO FINAL\n\n` +
                        `Tem ABSOLUTA CERTEZA que deseja excluir o usu√°rio "<%= user.name %>"?\n\n` +
                        `Esta a√ß√£o √© IRREVERS√çVEL!`
                    );
                    
                    if (confirmed) {
                        const button = document.getElementById('confirm-delete');
                        button.disabled = true;
                        button.innerHTML = '‚è≥ Excluindo...';
                        this.submit();
                    }
                });
            }

            // Interceptar envio do formul√°rio de exclus√£o for√ßada
            const forceDeleteForm = document.getElementById('force-delete-form');
            if (forceDeleteForm) {
                forceDeleteForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const confirmed = confirm(
                        `üö® EXCLUS√ÉO FOR√áADA - ATEN√á√ÉO M√ÅXIMA!\n\n` +
                        `Voc√™ est√° prestes a FOR√áAR a exclus√£o do usu√°rio "<%= user.name %>" e TODAS as suas <%= taskStats.total %> tarefa(s)!\n\n` +
                        `Esta a√ß√£o √© EXTREMAMENTE PERIGOSA e IRREVERS√çVEL!\n\n` +
                        `Tem ABSOLUTA CERTEZA?`
                    );
                    
                    if (confirmed) {
                        const secondConfirm = confirm(
                            `‚ö†Ô∏è SEGUNDA CONFIRMA√á√ÉO OBRIGAT√ìRIA\n\n` +
                            `Digite "CONFIRMO" na pr√≥xima tela para prosseguir com a exclus√£o for√ßada.`
                        );
                        
                        if (secondConfirm) {
                            const finalConfirm = prompt(
                                `Digite exatamente "CONFIRMO" para prosseguir com a exclus√£o for√ßada:`
                            );
                            
                            if (finalConfirm === "CONFIRMO") {
                                const button = document.getElementById('force-delete-btn');
                                button.disabled = true;
                                button.innerHTML = 'üí• For√ßando Exclus√£o...';
                                this.submit();
                            } else {
                                alert('‚ùå Exclus√£o cancelada. Texto de confirma√ß√£o incorreto.');
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
