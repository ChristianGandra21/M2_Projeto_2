<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Exclus√£o - <%= user.name %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö†Ô∏è Confirmar Exclus√£o de Usu√°rio</h1>
            <nav>
                <a href="/users" class="btn btn-secondary">‚¨ÖÔ∏è Voltar para Lista</a>
                <a href="/users/edit/<%= user.id %>" class="btn btn-primary">‚úèÔ∏è Editar Usu√°rio</a>
            </nav>
        </header>

        <main>
            <!-- Informa√ß√µes do Usu√°rio -->
            <div class="card">
                <div class="warning-header">
                    <h2>üö® Aten√ß√£o: Exclus√£o Permanente</h2>
                    <p>Voc√™ est√° prestes a excluir permanentemente o seguinte usu√°rio:</p>
                </div>

                <div class="user-details">
                    <div class="user-avatar-large">
                        <span class="avatar-text-large">
                            <%= user.name.charAt(0).toUpperCase() %>
                        </span>
                    </div>

                    <div class="user-info-detailed">
                        <h3 class="user-name-large">üë§ <%= user.name %></h3>
                        <p class="user-email-large">üìß <%= user.email %></p>
                        <p class="user-id-large">üÜî ID: <%= user.id %></p>
                        <% if (user.created_at) { %>
                        <p class="user-date-large">
                            üìÖ Criado em: <%= new Date(user.created_at).toLocaleDateString('pt-BR') %>
                        </p>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Verifica√ß√£o de Tarefas -->
            <div class="card">
                <h3>üîç Verifica√ß√£o de Depend√™ncias</h3>
                <div id="tasks-check">
                    <% if (taskStats.total > 0) { %>
                        <div class="alert alert-warning">
                            <h4>‚ö†Ô∏è <%= taskStats.total %> Tarefa(s) Encontrada(s)</h4>
                            <div class="task-stats">
                                <span class="stat-item">
                                    <span class="stat-number completed"><%= taskStats.completed %></span>
                                    <span class="stat-label">Conclu√≠das</span>
                                </span>
                                <span class="stat-item">
                                    <span class="stat-number pending"><%= taskStats.pending %></span>
                                    <span class="stat-label">Pendentes</span>
                                </span>
                            </div>
                            <p>Este usu√°rio possui as seguintes tarefas associadas:</p>
                            <ul class="tasks-list">
                                <% userTasks.forEach(task => { %>
                                <li>
                                    <strong><%= task.title %></strong>
                                    <% if (task.completed) { %>
                                        <span class="badge badge-success">‚úÖ Conclu√≠da</span>
                                    <% } else { %>
                                        <span class="badge badge-warning">‚è≥ Pendente</span>
                                    <% } %>
                                    <% if (task.due_date) { %>
                                        <small class="task-date">üìÖ <%= new Date(task.due_date).toLocaleDateString('pt-BR') %></small>
                                    <% } %>
                                </li>
                                <% }) %>
                            </ul>
                        </div>
                    <% } else { %>
                        <div class="alert alert-success">
                            <h4>‚úÖ Nenhuma Tarefa Encontrada</h4>
                            <p>Este usu√°rio n√£o possui tarefas associadas. A exclus√£o pode prosseguir com seguran√ßa.</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- A√ß√µes de Confirma√ß√£o -->
            <div class="card">
                <div class="confirmation-actions">
                    <div class="warning-message">
                        <h3>‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!</h3>
                        <p>Ao confirmar, o usu√°rio ser√° permanentemente removido do sistema.</p>
                    </div>

                    <% if (taskStats.total > 0) { %>
                        <!-- Usu√°rio tem tarefas -->
                        <div class="blocked-message">
                            <div class="alert alert-danger">
                                <h4>‚ùå Exclus√£o Bloqueada</h4>
                                <p>Este usu√°rio n√£o pode ser exclu√≠do porque possui <strong><%= taskStats.total %> tarefa(s)</strong> associada(s>.</p>
                                <ul>
                                    <li>Remover todas as tarefas do usu√°rio</li>
                                    <li>Reatribuir as tarefas para outro usu√°rio</li>
                                    <li>Solicitar exclus√£o for√ßada (administrador)</li>
                                </ul>
                            </div>
                            <div class="blocked-actions">
                                <a href="/tasks" class="btn btn-primary">üìã Gerenciar Tarefas</a>
                                <a href="/users" class="btn btn-secondary">‚¨ÖÔ∏è Voltar</a>

                                <div class="force-delete-section">
                                    <h5>üîê Exclus√£o For√ßada</h5>
                                    <p class="warning-text">‚ö†Ô∏è Esta op√ß√£o remove o usu√°rio E todas as suas tarefas!</p>
                                    <button class="btn btn-danger btn-large" id="force-delete-btn">
                                        üí• For√ßar Exclus√£o (Admin)
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% } else { %>
                        <!-- Sem tarefas -->
                        <div class="action-buttons">
                            <button class="btn btn-danger btn-large" id="confirm-delete">
                                üóëÔ∏è Confirmar Exclus√£o
                            </button>
                            <a href="/users" class="btn btn-secondary btn-large">‚ùå Cancelar</a>
                        </div>
                    <% } %>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userId = "<%= user.id %>";
            const userName = "<%= user.name %>";
            const taskCount = <%= taskStats.total %>;

            const deleteBtn = document.getElementById('confirm-delete');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function () {
                    const confirmed = confirm(
                        `üö® CONFIRMA√á√ÉO FINAL\n\n` +
                        `Tem certeza que deseja excluir o usu√°rio "${userName}"?\n` +
                        `Esta a√ß√£o √© IRREVERS√çVEL!`
                    );
                    if (confirmed) {
                        deleteBtn.disabled = true;
                        deleteBtn.innerHTML = '‚è≥ Excluindo...';

                        fetch(`/users/delete/${userId}`, {
                            method: 'POST'
                        })
                        .then(res => {
                            if (res.ok) {
                                window.location.href = '/users';
                            } else {
                                alert('Erro ao excluir usu√°rio.');
                                deleteBtn.disabled = false;
                                deleteBtn.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                            }
                        })
                        .catch(err => {
                            alert('Erro de rede.');
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = 'üóëÔ∏è Confirmar Exclus√£o';
                        });
                    }
                });
            }

            const forceDeleteBtn = document.getElementById('force-delete-btn');
            if (forceDeleteBtn) {
                forceDeleteBtn.addEventListener('click', function () {
                    const confirm1 = confirm(
                        `üö® EXCLUS√ÉO FOR√áADA!\n\n` +
                        `Voc√™ est√° prestes a excluir o usu√°rio "${userName}" e todas suas ${taskCount} tarefas!\n` +
                        `Tem certeza?`
                    );
                    if (!confirm1) return;

                    const confirm2 = confirm(
                        `‚ö†Ô∏è SEGUNDA CONFIRMA√á√ÉO\n\nDigite "CONFIRMO" na pr√≥xima tela para prosseguir.`
                    );
                    if (!confirm2) return;

                    const input = prompt('Digite exatamente "CONFIRMO" para prosseguir:');
                    if (input !== 'CONFIRMO') {
                        alert('‚ùå Exclus√£o cancelada. Texto incorreto.');
                        return;
                    }

                    forceDeleteBtn.disabled = true;
                    forceDeleteBtn.innerHTML = 'üí• For√ßando Exclus√£o...';

                    fetch(`/users/delete/${userId}?force=true`, {
                        method: 'POST'
                    })
                    .then(res => {
                        if (res.ok) {
                            window.location.href = '/users';
                        } else {
                            alert('Erro ao for√ßar exclus√£o.');
                            forceDeleteBtn.disabled = false;
                            forceDeleteBtn.innerHTML = 'üí• For√ßar Exclus√£o (Admin)';
                        }
                    })
                    .catch(err => {
                        alert('Erro de rede.');
                        forceDeleteBtn.disabled = false;
                        forceDeleteBtn.innerHTML = 'üí• For√ßar Exclus√£o (Admin)';
                    });
                });
            }
        });
    </script>
</body>
</html>
