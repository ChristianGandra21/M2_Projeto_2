<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Usu√°rios</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <h1>üë§ Usu√°rios</h1>
    <nav>
      <a href="/">‚¨ÖÔ∏è Voltar</a>
    </nav>

    <ul id="user-list"></ul>

    <!-- Se√ß√£o de Usu√°rios -->
    <div class="card">
      <div class="section-header">
        <h2>üë• Lista de Usu√°rios</h2>
        <a href="/users/new" class="btn btn-success">üë§ Criar Usu√°rio</a>
      </div>

      <% if (users.length === 0) { %>
      <div class="alert alert-info">
        <p>
          Nenhum usu√°rio cadastrado.
          <a href="/users/new">Criar primeiro usu√°rio</a>
        </p>
      </div>
      <% } else { %>
      <div class="users-grid">
        <% users.forEach(user => { %>
        <div class="user-card">
          <div class="user-avatar">
            <span class="avatar-text">
              <%= user.name.charAt(0).toUpperCase() %>
            </span>
          </div>

          <div class="user-info">
            <h3 class="user-name"><%= user.name %></h3>
            <p class="user-email">üìß <%= user.email %></p>
            <p class="user-id">üÜî ID: <%= user.id %></p>
            <% if (user.created_at) { %>
            <p class="user-date">
              üìÖ <%= new Date(user.created_at).toLocaleDateString('pt-BR') %>
            </p>
            <% } %>
          </div>

          <div class="user-actions">
            <a
              href="/users/edit/<%= user.id %>"
              class="btn btn-sm btn-secondary"
              >‚úèÔ∏è Editar</a
            >

            <form
              action="/users/delete/<%= user.id %>"
              method="POST"
              style="display: inline"
              class="delete-form"
              data-user-name="<%= user.name %>"
            >
              <button type="submit" class="btn btn-sm btn-danger">
                üóëÔ∏è Excluir
              </button>
            </form>
          </div>
        </div>
        <% }) %>
      </div>
      <% } %>
    </div>

    <!-- Container para mensagens -->
    <div id="messages-container"></div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Mostrar mensagens de sucesso/erro baseadas nos par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get("success");
        const name = urlParams.get("name");
        const messagesContainer = document.getElementById("messages-container");

        if (success && messagesContainer) {
          let message = "";
          let alertClass = "alert-success";

          switch (success) {
            case "user_created":
              message = `‚úÖ Usu√°rio "${
                name || "sem nome"
              }" foi criado com sucesso!`;
              break;
            case "user_updated":
              message = `‚úÖ Usu√°rio "${
                name || "sem nome"
              }" foi atualizado com sucesso!`;
              break;
            case "user_deleted":
              message = `‚úÖ Usu√°rio "${
                name || "sem nome"
              }" foi exclu√≠do com sucesso!`;
              break;
            default:
              message = "‚úÖ Opera√ß√£o realizada com sucesso!";
          }

          if (message) {
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #155724;">√ó</button>
                    </div>
                `;
            messagesContainer.appendChild(alertDiv);

            // Auto-remover ap√≥s 5 segundos
            setTimeout(() => {
              if (alertDiv.parentNode) {
                alertDiv.remove();
              }
            }, 5000);

            // Limpar URL sem recarregar a p√°gina
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
          }
        }

        // Confirma√ß√£o de exclus√£o
        document.addEventListener("submit", function (e) {
          if (e.target.classList.contains("delete-form")) {
            e.preventDefault();
            const userName = e.target.dataset.userName;

            if (
              confirm(
                `‚ö†Ô∏è Tem certeza que deseja excluir o usu√°rio "${userName}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`
              )
            ) {
              const button = e.target.querySelector("button");
              button.disabled = true;
              button.innerHTML = "‚è≥ Excluindo...";
              e.target.submit();
            }
          }
        });
      });
    </script>
  </body>
</html>
